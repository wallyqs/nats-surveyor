version: "3.9"

networks:
  monitor-net:
    driver: bridge

configs:
  sys_creds:
    file: ./SYS.creds
  nats_conf:
    file: ./nats.conf

services:
  nats:
    image: synadia/nats-server:nightly
    container_name: nats-server
    restart: always
    entrypoint: /bin/nats-server
    command: -c /nats.conf -DV
    networks:
      - monitor-net
    configs:
      - source: nats_conf
        target: /nats_conf
        uid: '103'
        gid: '103'
        mode: 0440

  surveyor:
    image: synadia/nats-surveyor:${SURVEYOR_DOCKER_TAG}
    container_name: nats-surveyor
    restart: always
    volumes:
      - ./observations:/observations
      - ./jetstream:/jetstream
    entrypoint: /nats-surveyor
    command: -c ${NATS_SURVEYOR_SERVER_COUNT} -creds /SYS.creds -s nats -observe /observations
    networks:
      - monitor-net
    labels:
      org.label-schema.group: "nats-monitoring"
    configs:
      - sys_creds

  prometheus:
    image: prom/prometheus:${PROMETHEUS_DOCKER_TAG}
    container_name: prometheus
    restart: always
    volumes:
      - ./prometheus/:/etc/prometheus/
      - $PROMETHEUS_STORAGE:/usr/local/share/prometheus
    command: --config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/usr/local/share/prometheus
    networks:
      - monitor-net
    labels:
      org.label-schema.group: "nats-monitoring"
    depends_on:
      - surveyor

  grafana:
    image: grafana/grafana:${GRAFANA_DOCKER_TAG}
    container_name: grafana
    restart: always
    ports:
      - "3000:3000"
    volumes:
      - ./grafana/dashboards:/var/lib/grafana/dashboards
      - ./grafana/provisioning:/etc/grafana/provisioning
    networks:
      - monitor-net
    labels:
      org.label-schema.group: "nats-monitoring"
    depends_on:
      - prometheus
